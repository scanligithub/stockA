name: Sync Release to HF

on:
  workflow_dispatch:
    inputs:
      file_pattern:
        description: 'Pattern (e.g. *)'
        default: '*'
        required: true

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.10"
      - run: pip install huggingface_hub
      
      - name: Download from Release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          mkdir downloads
          # ä¸‹è½½ç¬¦åˆ pattern çš„æ–‡ä»¶åˆ° downloads ç›®å½•
          gh release download archive -D downloads --pattern "${{ inputs.file_pattern }}" || echo "âš ï¸ No files found or Release missing"
          
      - name: Upload to HF
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
          HF_REPO: ${{ secrets.HF_REPO }}
        run: |
          python -c "
          from huggingface_hub import HfApi
          import os
          import glob
          
          # 1. è·å–æ‰€æœ‰ä¸‹è½½çš„æ–‡ä»¶
          files = glob.glob('downloads/*')
          print(f'ğŸ“‚ Found {len(files)} files in downloads folder.')
          
          if len(files) == 0:
              print('âš ï¸ No files found to upload. Please check if the Release exists and contains files.')
              exit(0) # ä¼˜é›…é€€å‡º
          
          api = HfApi(token=os.getenv('HF_TOKEN'))
          repo = os.getenv('HF_REPO')
          
          print(f'ğŸ¯ Target Repo: {repo}')
          
          for f in files:
              if os.path.isfile(f):
                  fname = os.path.basename(f)
                  print(f'ğŸš€ Uploading {fname} ...')
                  try:
                      api.upload_file(
                          path_or_fileobj=f, 
                          path_in_repo=fname, 
                          repo_id=repo, 
                          repo_type='dataset'
                      )
                      print(f'âœ… {fname} success.')
                  except Exception as e:
                      print(f'âŒ Failed to upload {fname}: {e}')
                      # ä¸é€€å‡ºï¼Œç»§ç»­ä¼ ä¸‹ä¸€ä¸ª
          "
