name: Daily Update to HF (Matrix)

on:
  schedule:
    - cron: '0 18 * * *' # UTC 18:00 = 北京时间凌晨 02:00
  workflow_dispatch:     # 允许手动点击测试

permissions:
  contents: read

jobs:
  # 1. 准备分片矩阵 (随机打乱 20 个分片)
  prepare:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.10"
      - run: pip install baostock pandas
      - id: set-matrix
        run: |
          python scripts/prepare_matrix.py
          echo "matrix=$(cat stock_matrix.json)" >> $GITHUB_OUTPUT

  # 2. 并发下载当年数据 (YTD模式)
  fetch-stocks:
    needs: prepare
    runs-on: ubuntu-latest
    strategy:
      matrix:
        task: ${{ fromJson(needs.prepare.outputs.matrix) }}
      fail-fast: false
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.10"
          cache: 'pip'
      - run: pip install -r requirements.txt
      - name: Fetch Current Year Data
        run: |
          # 不传 --year 或传 0 默认为 YTD 模式 (今年1.1~昨天)
          python scripts/fetch_worker.py \
            --index ${{ matrix.task.index }} \
            --codes '${{ toJson(matrix.task.codes) }}'
            
      - uses: actions/upload-artifact@v4
        with:
          name: daily-parts-${{ matrix.task.index }}
          path: temp_parts/*.parquet
          retention-days: 1

  # 3. 下载最新板块行情与成分
  fetch-sectors:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.10"
          cache: 'pip'
      - run: pip install -r requirements.txt
      - name: Fetch Sectors
        env:
          CF_WORKER_URL: ${{ secrets.CF_WORKER_URL }}
        run: python scripts/fetch_sector.py
      - uses: actions/upload-artifact@v4
        with:
          name: sector-parts
          path: temp_parts/*.parquet
          retention-days: 1

  # 4. 汇总、质检、推送到 Hugging Face
  finalize:
    needs: [fetch-stocks, fetch-sectors]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.10"
      - run: pip install -r requirements.txt
      
      - name: Download All Artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: '*'
          merge-multiple: true
          path: all_artifacts
          
      - name: Merge & Push to HF
        env:
          HF_TOKEN: ${{ secrets.HF_TOKEN }}
          HF_REPO: ${{ secrets.HF_REPO }}
        run: |
          # mode hf 会自动调用 hf_manager 进行上传
          python scripts/merge_and_push.py --mode hf
          
      - name: Upload QC Report to Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: daily-qc-report
          path: |
            output/qc_report.json
            output/qc_summary.md
          retention-days: 3
          
      - name: Publish Summary
        if: always()
        run: cat output/qc_summary.md >> $GITHUB_STEP_SUMMARY
